<!DOCTYPE html>  <html> <head>   <title>keg.io.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="keg.db.html">                 keg.db.js               </a>                                           <a class="source" href="keg.io.html">                 keg.io.js               </a>                                           <a class="source" href="keg.tweet.html">                 keg.tweet.js               </a>                                           <a class="source" href="server.html">                 server.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               keg.io.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The 'main' server-side class</p>

<p>The KegIo object is an event emitter, and serves as the primary object with which the server.js
code interacts. This object encapsulates and maintains the necessary ojbects for working with 
the DB and Twitter functionality.  Additionally, it's responsible for communicating with the 
arduino microcontroller via the serial port.</p>

<h2>Protocol definition</h2>

<p>The "protocol" we're using to communicate with the arduino consists of the following messages:</p>

<p><strong>arduino --> node</strong>         </p>

<ul>
<li><code>**FLOW_number**</code> (<em>number</em> indicates the current flow rate, where <em>number</em> is in liters/min)  </li>
<li><code>**FLOW_END**</code>    (indicates that pouring is complete e.g. solenoid closed)</li>
<li><code>**TAG_rfid**</code>    (<em>rfid</em> indicates an rfid scan, where <em>rfid</em> is the value that was scanned)</li>
<li><code>**TAG_0000000000**</code>    (special case of the above: solenoid closed)</li>
<li><code>**TEMP_temp**</code>    (<em>temp</em> indicates the current keg temp, where <em>temp</em> is in F)</li>
</ul>

<p><strong>node --> arduino</strong> </p>

<ul>
<li><code>**REQUEST_TAG**</code>    (requests the last rfid tag scanned)</li>
<li><code>**REQUEST_TEMP**</code>    (requests the current temperature)</li>
<li><code>**REQUEST_FLOW**</code>    (requests the current flow rate)</li>
<li><code>**REQUEST_OPEN**</code>    (requests that the solenoid open to pour some brewski)     </li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">binding</span><span class="p">(</span><span class="s1">&#39;natives&#39;</span><span class="p">).</span><span class="nx">util</span> <span class="o">?</span> <span class="s1">&#39;util&#39;</span> <span class="o">:</span> <span class="s1">&#39;sys&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">keg_db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;keg.db&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">keg_tweet</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;keg.tweet&#39;</span><span class="p">)</span>	
 	<span class="p">,</span> <span class="nx">kegDb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">keg_db</span><span class="p">.</span><span class="nx">KegDb</span><span class="p">()</span>
	<span class="p">,</span> <span class="nx">kegTwit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">keg_tweet</span><span class="p">.</span><span class="nx">KegTwit</span><span class="p">()</span>
	<span class="p">,</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>

<span class="nx">Keg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TAG&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;FLOW&#39;</span><span class="p">];</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">lastRfidSeen</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">arduino</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> 
	<span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">totalFlowAmount</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">lastFlowTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>                           
	<span class="k">this</span><span class="p">.</span><span class="nx">adminUiPassword</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>  
	<span class="k">this</span><span class="p">.</span><span class="nx">highTempThreshold</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Regex to validate messages from the arduino, according to the protocol definition above.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">validMessage</span> <span class="o">=</span> <span class="sr">/\\*\\*.+_.+\\*\\*/i</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This object is an event emitter.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Keg</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">);</span>

<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> 
							  <span class="nx">dev</span><span class="p">,</span> 
							  <span class="nx">dbName</span><span class="p">,</span> 
							  <span class="nx">twitterEnabled</span><span class="p">,</span> 
							  <span class="nx">twitterConsumerKey</span><span class="p">,</span>
							  <span class="nx">twitterConsumerSecret</span><span class="p">,</span>
 							  <span class="nx">twitterAccessTokenKey</span><span class="p">,</span>
							  <span class="nx">twitterAccessTokenSecret</span><span class="p">,</span>
							  <span class="nx">adminUiPassword</span><span class="p">,</span>
							  <span class="nx">highTempThreshold</span><span class="p">)</span> <span class="p">{</span>       
	                    
	<span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">;</span>    
	<span class="k">this</span><span class="p">.</span><span class="nx">adminUiPassword</span> <span class="o">=</span> <span class="nx">adminUiPassword</span><span class="p">;</span>  
	<span class="k">this</span><span class="p">.</span><span class="nx">highTempThreshold</span> <span class="o">=</span> <span class="nx">highTempThreshold</span><span class="p">;</span>
	
	<span class="nx">kegDb</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="nx">twitterEnabled</span><span class="p">)</span>
	 <span class="p">{</span>               </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Initialize the Twitter module, passing in all the necessary config values (that represent our API keys) </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">kegTwit</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span>
					 <span class="nx">twitterConsumerKey</span><span class="p">,</span>
					 <span class="nx">twitterConsumerSecret</span><span class="p">,</span>
		 			 <span class="nx">twitterAccessTokenKey</span><span class="p">,</span>
					 <span class="nx">twitterAccessTokenSecret</span><span class="p">);</span>
	 <span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">throw</span> <span class="s2">&quot;No serial port defined.&quot;</span><span class="p">;</span>
	<span class="p">}</span>  
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">dev</span> <span class="o">==</span> <span class="s2">&quot;DEVMODE&quot;</span><span class="p">)</span>
	<span class="p">{</span>                                 </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>If 'DEVMODE' is used as the device name (instead of a real device like /dev/ttyUSB0), the code will
generate random events, rather than attempting to communicate with a real arduino.  This is very helpful
for development/debugging, when the actual hardware isn't available.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;!!Using DEVMODE data instead of a serial port!!&#39;</span><span class="p">);</span>                
		<span class="k">this</span><span class="p">.</span><span class="nx">fakePour</span><span class="p">();</span> 
		<span class="k">this</span><span class="p">.</span><span class="nx">fakeTemp</span><span class="p">();</span>  
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">this</span><span class="p">.</span><span class="nx">device</span> <span class="o">=</span> <span class="nx">dev</span><span class="p">;</span> <span class="c1">// assign serial port to this keg object</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">// initialize empty string to store incoming serial port data</span>
	<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="c1">// initialize self so &#39;this&#39; is accessible in events below</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>attach to the serial port device and then setup listeners for error, open, and data</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span> <span class="p">{</span> <span class="nx">bufferSize</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
	<span class="nx">f</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Serial port read error. Check that device is valid \&#39;&#39;</span> <span class="o">+</span> <span class="nx">dev</span> <span class="o">+</span> <span class="s1">&#39;\&#39;&#39;</span><span class="p">);</span>
		<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Exiting...&#39;</span><span class="p">);</span>
		<span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">});</span>

	<span class="nx">f</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="p">{</span> 
		<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Successfully opened serial port \&#39;&#39;</span> <span class="o">+</span> <span class="nx">dev</span> <span class="o">+</span> <span class="s1">&#39;\&#39; for reading from kegerator&#39;</span><span class="p">);</span>
	<span class="p">});</span>

	<span class="nx">f</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span> 

        <span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">));</span>
          
		<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/.*/</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// Only keep hex chars</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">c</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// Found non-hex char</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="c1">// The ID isn&#39;t blank</span>
				<span class="nx">self</span><span class="p">.</span><span class="nx">_onData</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
			<span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">// Prepare for the next ID chunks</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nx">id</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span> <span class="c1">// Add to the ID</span>
	<span class="p">});</span>                                                      
	</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>attach to the serial port device so data can be sent to arduino</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">arduino</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">arduino</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Serial port write error. Check that device is valid \&#39;&#39;</span> <span class="o">+</span> <span class="nx">dev</span> <span class="o">+</span> <span class="s1">&#39;\&#39;&#39;</span><span class="p">);</span>
		<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Exiting...&#39;</span><span class="p">);</span>
		<span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">});</span>
	
	<span class="k">this</span><span class="p">.</span><span class="nx">arduino</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Successfully opened serial port \&#39;&#39;</span> <span class="o">+</span> <span class="nx">dev</span> <span class="o">+</span> <span class="s1">&#39;\&#39; for writing to kegerator&#39;</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span>

<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTemperatureTrend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">kegDb</span><span class="p">.</span><span class="nx">getTemperatureHistory</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">){</span>
		
		<span class="kd">var</span> <span class="nx">formattedData</span> <span class="o">=</span> <span class="p">[];</span>  
		<span class="k">if</span> <span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				<span class="kd">var</span> <span class="nx">dateObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">temperature_date</span><span class="p">);</span>
				<span class="nx">prettyDate</span> <span class="o">=</span> <span class="nx">dateObj</span><span class="p">.</span><span class="nx">toDateString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">dateObj</span><span class="p">.</span><span class="nx">toTimeString</span><span class="p">();</span>
				<span class="nx">formattedData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">[</span><span class="nx">prettyDate</span><span class="p">,</span> <span class="nx">row</span><span class="p">.</span><span class="nx">temperature</span><span class="p">]</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;temperatureHistory&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">formattedData</span> <span class="p">});</span>
		<span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span>
          
<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getKegInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">kegDb</span><span class="p">.</span><span class="nx">getActiveKeg</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">){</span>
	   <span class="nx">callback</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rows</span><span class="p">));</span>      
	<span class="p">});</span>
<span class="p">};</span>

<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPourTrend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">kegDb</span><span class="p">.</span><span class="nx">getPourTotalsByUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">formattedData</span> <span class="o">=</span> <span class="p">[];</span>     
			<span class="k">if</span> <span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
					<span class="nx">formattedData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">[</span><span class="nx">row</span><span class="p">.</span><span class="nx">first_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">row</span><span class="p">.</span><span class="nx">last_name</span><span class="p">,</span> <span class="nx">row</span><span class="p">.</span><span class="nx">volume</span> <span class="p">]</span> <span class="p">);</span>
				<span class="p">}</span>
            <span class="p">}</span>
			<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;pourHistory&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">formattedData</span> <span class="p">});</span>	
			<span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span>

<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPercentRemaining</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">kegDb</span><span class="p">.</span><span class="nx">getPourHistory</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">totalPoured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           
		<span class="k">if</span> <span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				<span class="nx">totalPoured</span> <span class="o">+=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">volume_ounces</span><span class="p">);</span>
			<span class="p">}</span>    
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">kegTotalVolume</span> <span class="o">=</span> <span class="mi">124</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>  <span class="c1">// 124 pints * 16 ounces per pint</span>
		<span class="nx">callback</span><span class="p">(</span> <span class="nx">totalPoured</span> <span class="o">/</span> <span class="nx">kegTotalVolume</span> <span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span>
        
<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hashEmail</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
<span class="p">{</span>       
	<span class="kd">var</span> <span class="nx">md5Hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>              
	<span class="k">if</span> <span class="p">((</span><span class="nx">email</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="nx">md5Hash</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">email</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">);</span>      
	<span class="p">}</span>
	<span class="nx">callback</span><span class="p">(</span><span class="nx">md5Hash</span><span class="p">);</span>
<span class="p">};</span>
                          </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Produces a fake "flow" event on a given interval, used in development mode         </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fakeFlow</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fakeFlow</span><span class="p">(</span><span class="nx">flowsLeft</span><span class="p">)</span>
<span class="p">{</span>                        
	<span class="kd">var</span> <span class="nx">frequencyInMs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>       <span class="c1">// repeat every second</span>
	<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>             
	
	<span class="k">if</span> <span class="p">(</span><span class="nx">flowsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>     
			<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;emitting fake flow&quot;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">randomFlow</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">31</span><span class="p">))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// between 10-40   </span>
			<span class="nx">self</span><span class="p">.</span><span class="nx">_onData</span><span class="p">(</span><span class="s2">&quot;**FLOW_&quot;</span> <span class="o">+</span> <span class="nx">randomFlow</span> <span class="o">+</span><span class="s2">&quot;**&quot;</span><span class="p">);</span>
			<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">fakeFlow</span><span class="p">(</span><span class="nx">flowsLeft</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">frequencyInMs</span><span class="p">);</span> 
			<span class="p">},</span> <span class="nx">frequencyInMs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>                                </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>(In Fred Armisen from Portandia voice): "This flow is <strong>OVER</strong>!!!"</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">self</span><span class="p">.</span><span class="nx">_onData</span><span class="p">(</span><span class="s2">&quot;**FLOW_END**&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>
                         </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Produces a fake "pour" event on a given interval, used in development mode</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fakePour</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fakePour</span><span class="p">()</span>
<span class="p">{</span>                        
	<span class="kd">var</span> <span class="nx">frequencyInMs</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>	<span class="c1">// repeat every 10 seconds</span>
	<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>         
	<span class="k">this</span><span class="p">.</span><span class="nx">fakeFlow</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>   <span class="c1">// flow for 5 seconds               </span>
	                                                         </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Select a random user, using values that we "know" are in the DB,
(based on the fact that they're hardcoded into the DB rebuild script)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">randomUser</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// between 0-2</span>
	<span class="kd">var</span> <span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="nx">randomUser</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span><span class="o">:</span>       
			<span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;2312A4B540&quot;</span><span class="p">;</span>	<span class="c1">// Dylan</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>                                 
			<span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;2312A4B541&quot;</span><span class="p">;</span> 	<span class="c1">// Chris</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
			<span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;2312A4B542&quot;</span><span class="p">;</span> 	<span class="c1">// Carl</span>
		<span class="k">break</span><span class="p">;</span>   
		<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
			<span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;2312A4B543&quot;</span><span class="p">;</span>  <span class="c1">// Garrett</span>
		<span class="k">break</span><span class="p">;</span>         
		<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
			<span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;DENYTAG544&quot;</span><span class="p">;</span>  <span class="c1">//deny user   </span>
		<span class="k">break</span><span class="p">;</span>  
		<span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
			<span class="nx">userRFID</span> <span class="o">=</span> <span class="s2">&quot;DENYTAG545&quot;</span><span class="p">;</span>  <span class="c1">//deny user    </span>
		<span class="k">break</span><span class="p">;</span>                         
	<span class="p">}</span>
	                   
	<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>     
		<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;emitting fake pour&quot;</span><span class="p">);</span>    
		<span class="nx">self</span><span class="p">.</span><span class="nx">_onData</span><span class="p">(</span><span class="s2">&quot;**TAG_&quot;</span> <span class="o">+</span> <span class="nx">userRFID</span> <span class="o">+</span> <span class="s2">&quot;**&quot;</span><span class="p">);</span> 
		<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">fakePour</span><span class="p">(),</span> <span class="nx">frequencyInMs</span><span class="p">);</span>
		<span class="p">},</span> <span class="nx">frequencyInMs</span><span class="p">);</span>
<span class="p">};</span>                      
              </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Produces a fake "temp" event on a given interval, used in development mode         </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fakeTemp</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fakeTemp</span><span class="p">()</span>
<span class="p">{</span>                        
	<span class="kd">var</span> <span class="nx">frequencyInMs</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>    <span class="c1">// repeat every 3 seconds </span>
	<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> 
	<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
		<span class="kd">var</span> <span class="nx">randomTemp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">101</span><span class="p">);</span> <span class="c1">// between 0-100</span>
	    <span class="nx">self</span><span class="p">.</span><span class="nx">_onData</span><span class="p">(</span><span class="s2">&quot;**TEMP_&quot;</span> <span class="o">+</span> <span class="nx">randomTemp</span> <span class="o">+</span> <span class="s2">&quot;**&quot;</span><span class="p">);</span>
		<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">fakeTemp</span><span class="p">(),</span> <span class="nx">frequencyInMs</span><span class="p">);</span> 
		<span class="p">},</span> <span class="nx">frequencyInMs</span><span class="p">);</span>
<span class="p">};</span>
	
<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isValidMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validMessage</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>add insert new user code here
parse form response    </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">kegiopassword</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">adminUiPassword</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">twitterusername</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
				<span class="nx">data</span><span class="p">.</span><span class="nx">twitterusername</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">twitterusername</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>	
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">isnewuser</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">){</span>
				<span class="nx">kegDb</span><span class="p">.</span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">usertag</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">userExists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="nx">rows</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span> 
						<span class="nx">userExists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>first<em>name, last</em>name, rfid, email</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="nx">userExists</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>  
						<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;New user added via UI: &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lastname</span><span class="p">);</span>
						<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
						<span class="nx">kegDb</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">usertag</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">twitterusername</span><span class="p">);</span>	
						<span class="nx">callback</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">}));</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;A user for this tag already exists&quot;</span><span class="p">);</span>
						<span class="nx">callback</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span><span class="s1">&#39;User already exists&#39;</span><span class="p">,</span> <span class="nx">fields</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;usertag&#39;</span><span class="p">]}}));</span>
					<span class="p">}</span>                             
				<span class="p">});</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>update existing user    </p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">kegDb</span><span class="p">.</span><span class="nx">updateUser</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">usertag</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">twitterusername</span><span class="p">);</span>
				<span class="nx">callback</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">}));</span>	
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Invalid admin UI password!&quot;</span><span class="p">);</span>
			<span class="nx">callback</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span><span class="s1">&#39;Invalid keg.io password&#39;</span><span class="p">,</span> <span class="nx">fields</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;kegiopassword&#39;</span><span class="p">]}}));</span>	
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
	
<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_allowPour</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>   
	<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">arduino</span><span class="p">)</span>
	<span class="p">{</span>  
		<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Sending a **REQUEST_OPEN** to the arduino&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">arduino</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;**REQUEST_OPEN**&quot;</span><span class="p">);</span>       
		<span class="k">this</span><span class="p">.</span><span class="nx">arduino</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">);</span>  
	<span class="p">}</span>
	<span class="k">else</span> 
	<span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;this.arduino is undefined&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>
	
<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_calculatePourVolume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">flowRate</span><span class="p">,</span> <span class="nx">flowTime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">lastFlowTime</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">flowRate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Capture the first time that we got a flow event</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">lastFlowTime</span> <span class="o">=</span> <span class="nx">flowTime</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>1 liter per minute = 0.000563567045 US fluid ounces per millisecond
1 liter per hour = 0.00000939278408 US fluid ounces per millisecond</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">diffInMs</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">flowTime</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastFlowTime</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">lastFlowTime</span> <span class="o">=</span> <span class="nx">flowTime</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">newFlowAmountInOz</span> <span class="o">=</span> <span class="nx">diffInMs</span> <span class="o">*</span> <span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">flowRate</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.00000939278408</span><span class="p">);</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;diffInMs: &quot;</span> <span class="o">+</span> <span class="nx">diffInMs</span><span class="p">);</span>	
	<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;newFlowAmountInOz: &quot;</span> <span class="o">+</span> <span class="nx">newFlowAmountInOz</span><span class="p">);</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">totalFlowAmount</span> <span class="o">+=</span> <span class="nx">newFlowAmountInOz</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;new flow total is: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">totalFlowAmount</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Keg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_onData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>don't continue if the message received isn't valid</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isValidMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span> 
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Display the "raw" message</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
	</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>determine the type of message and emit the proper event</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">startSlice</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">endSlice</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">));</span>
			<span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">startSlice</span><span class="p">,</span> <span class="nx">endSlice</span><span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set up some cleaned vars to use for our event handling</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">eventName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">eventData</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">eventTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
			
			<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Event: &quot;</span> <span class="o">+</span> <span class="nx">eventName</span> <span class="o">+</span> <span class="s2">&quot; Data: &quot;</span> <span class="o">+</span> <span class="nx">eventData</span> <span class="o">+</span>
						      <span class="s2">&quot; Time: &quot;</span> <span class="o">+</span> <span class="nx">eventTime</span><span class="p">.</span><span class="nx">toDateString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">eventTime</span><span class="p">.</span><span class="nx">toTimeString</span><span class="p">());</span>
			
			<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">())</span>
              <span class="p">{</span>
              <span class="k">case</span> <span class="s1">&#39;temp&#39;</span><span class="o">:</span>
                <span class="nx">kegDb</span><span class="p">.</span><span class="nx">addTemperature</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>    

				<span class="kd">var</span> <span class="nx">currentTemp</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">currentTemp</span> <span class="o">&gt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">highTempThreshold</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="nx">kegTwit</span><span class="p">.</span><span class="nx">tweetTemp</span><span class="p">(</span><span class="nx">currentTemp</span><span class="p">);</span>  
				<span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

              <span class="k">case</span> <span class="s1">&#39;tag&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>This event is a bit different, as there's nothing to really do yet.
We'll just keep track of which RFID was scanned, in case they do something later.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">lastRfidSeen</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
				<span class="nx">kegDb</span><span class="p">.</span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="nx">rows</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)){</span>                               
						<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Authenticated RFID: &quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>if a row is returned, user is valid. tell arduino to allow pour    </p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">self</span><span class="p">.</span><span class="nx">_allowPour</span><span class="p">();</span>
						</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Hash the email, then send an event to the UI with the relevant data</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">self</span><span class="p">.</span><span class="nx">hashEmail</span><span class="p">(</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
							<span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pour&quot;</span><span class="p">,</span> 
								<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span>
									<span class="p">{</span>
										<span class="s1">&#39;first_name&#39;</span><span class="o">:</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">first_name</span><span class="p">,</span>
										<span class="s1">&#39;last_name&#39;</span><span class="o">:</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">last_name</span><span class="p">,</span>
										<span class="s1">&#39;nickname&#39;</span><span class="o">:</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nickname</span><span class="p">,</span>
										<span class="s1">&#39;hash&#39;</span><span class="o">:</span><span class="nx">hash</span><span class="p">,</span>
										<span class="s1">&#39;email&#39;</span><span class="o">:</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">email</span><span class="p">,</span>
										<span class="s1">&#39;usertag&#39;</span><span class="o">:</span><span class="nx">d</span><span class="p">,</span>
										<span class="s1">&#39;twitter_handle&#39;</span><span class="o">:</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">twitter_handle</span>
									<span class="p">}</span>							
								<span class="p">)</span>
							<span class="p">);</span>   
						<span class="p">});</span>
					<span class="p">}</span>
					<span class="k">else</span> 
					<span class="p">{</span>
						<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Denied RFID: &quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>For some reason, we have to pass some data on the emit() call</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="k">if</span> <span class="p">(</span><span class="nx">eventData</span> <span class="o">!=</span> <span class="s1">&#39;0000000000&#39;</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;deny&quot;</span><span class="p">,</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s1">&#39;usertag&#39;</span><span class="o">:</span><span class="nx">d</span><span class="p">}));</span>
					<span class="p">}</span>
				<span class="p">});</span>
                <span class="k">break</span><span class="p">;</span>

              <span class="k">case</span> <span class="s1">&#39;flow&#39;</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastRfidSeen</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                <span class="p">{</span>
				   <span class="kd">var</span> <span class="nx">flowAmount</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
				   
				   <span class="k">if</span> <span class="p">(</span><span class="nx">flowAmount</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
					<span class="p">{</span>                                                                            </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>For some reason, our flow calculations are all coming in too low. <br />
They seem to be about 50% of what they should be. So.... multiply
everything by 2.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">self</span><span class="p">.</span><span class="nx">totalFlowAmount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">totalFlowAmount</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;That flow was: &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">totalFlowAmount</span><span class="p">);</span>
						</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>We're done pouring a beer. Send the total flow amount to the DB</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">kegDb</span><span class="p">.</span><span class="nx">addPour</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">lastRfidSeen</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">totalFlowAmount</span><span class="p">);</span>     
						
						<span class="kd">var</span> <span class="nx">ounces</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">totalFlowAmount</span><span class="p">));</span>
						                          
						<span class="k">if</span> <span class="p">(</span><span class="nx">ounces</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="p">{</span>                                                                               </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Gather user info from the DB</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="nx">kegDb</span><span class="p">.</span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">lastRfidSeen</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="nx">rows</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)){</span>                               
        							<span class="kd">var</span> <span class="nx">userInfo</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>      
									                       </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Gather beer info from the DB</p>             </td>             <td class="code">               <div class="highlight"><pre>									<span class="nx">kegDb</span><span class="p">.</span><span class="nx">getActiveKeg</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">){</span>  
										<span class="k">if</span> <span class="p">((</span><span class="nx">rows</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)){</span>      
											</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Tweet about it</p>             </td>             <td class="code">               <div class="highlight"><pre>											<span class="nx">kegTwit</span><span class="p">.</span><span class="nx">tweetPour</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">,</span> <span class="nx">ounces</span><span class="p">,</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
										<span class="p">}</span>
									<span class="p">});</span>		
								<span class="p">};</span>
							<span class="p">});</span>
					 	<span class="p">}</span>   
					
						<span class="nx">self</span><span class="p">.</span><span class="nx">getPercentRemaining</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">percent</span><span class="p">)</span> <span class="p">{</span>
							<span class="nx">self</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;PERCENT: &quot;</span> <span class="o">+</span> <span class="nx">percent</span><span class="p">);</span>
							<span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">percent</span><span class="p">)</span>
						<span class="p">});</span>
						<span class="nx">self</span><span class="p">.</span><span class="nx">lastFlowTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
						<span class="nx">self</span><span class="p">.</span><span class="nx">lastRfidSeen</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
						<span class="nx">self</span><span class="p">.</span><span class="nx">totalFlowAmount</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>We're still getting flow rate messages from the arduino. <br />
Calculate the flow amount and add it to our total.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">self</span><span class="p">.</span><span class="nx">_calculatePourVolume</span><span class="p">(</span><span class="nx">eventData</span><span class="p">,</span> <span class="nx">eventTime</span><span class="p">);</span>
					<span class="p">}</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>TODO: set an error.  We got an invalid message.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="p">}</span>
			
			<span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventData</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">Keg</span> <span class="o">=</span> <span class="nx">Keg</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 