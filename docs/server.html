<!DOCTYPE html>  <html> <head>   <title>server.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="keg.db.html">                 keg.db.js               </a>                                           <a class="source" href="keg.io.html">                 keg.io.js               </a>                                           <a class="source" href="keg.tweet.html">                 keg.tweet.js               </a>                                           <a class="source" href="server.html">                 server.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>About</h2>

<p><strong>keg.io</strong> is a techonology-laden kegerator, developed by VNC employees, to
satisfy their nerdiest beer-drinking needs.  It's built on node.js, and utilizes
an arduino microcontroller for interfacing with the actual keg HW and sensors.</p>

<p>It's got several cool features, including:  </p>

<ul>
<li>Gravatar support </li>
<li>Twitter integration</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Setup dependencies</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/lib/setup&quot;</span><span class="p">).</span><span class="nx">ext</span><span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/lib&quot;</span><span class="p">);</span>     
<span class="kd">var</span>	  <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">querystring</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;Socket.IO-node&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-static&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;choreographer&#39;</span><span class="p">).</span><span class="nx">router</span><span class="p">()</span>
	<span class="p">,</span> <span class="nx">keg_io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;keg.io&#39;</span><span class="p">)</span>
	<span class="p">,</span> <span class="nx">keg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">keg_io</span><span class="p">.</span><span class="nx">Keg</span><span class="p">()</span>
	<span class="p">,</span> <span class="nx">log4js</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;log4js&#39;</span><span class="p">)();</span>       

<span class="kd">function</span> <span class="nx">printUsage</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
<span class="p">{</span>                
 	<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;USAGE:&quot;</span><span class="p">)</span>
 	<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;node server.js &lt;path_to_config_file&gt;&quot;</span><span class="p">);</span>
 	<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;\tWhere &lt;path_to_config_file&gt; is the path to a JSON configuration file&quot;</span><span class="p">);</span>   
 	<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;\t containing all the required keg.io config options.  Optionally, the&quot;</span><span class="p">);</span>
 	<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;\t config file may contain C-style comments (/* */).&quot;</span><span class="p">)</span>
<span class="p">};</span>   
                                    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Setup our logging <br />
We're using <a href="http://log4js.berlios.de/"><strong>log4js</strong></a> for all of our logging <br />
The logging verbosity (particularly to the console for debugging) can be changed via the 
<strong>conf/log4js.json</strong> configuration file, using standard log4js log levels:</p>

<ul>
<li>OFF</li>
<li>FATAL</li>
<li>ERROR</li>
<li>WARN</li>
<li>INFO</li>
<li>DEBUG</li>
<li>TRACE</li>
<li>ALL</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">log4js</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;conf/log4js.json&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">log4js</span><span class="p">.</span><span class="nx">getLogger</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">);</span>   </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Make sure we got all the required cmdline args</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">{</span>  
	<span class="nx">printUsage</span><span class="p">(</span><span class="nx">logger</span><span class="p">);</span>
	<span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
	</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>echo all the args                   </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;ARGS:&quot;</span><span class="p">);</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">val</span><span class="p">);</span>
<span class="p">});</span>                                 </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Load our commented JSON configuration file, and echo it</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span>
	<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span>
		<span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;\\/\\*(.|\\r|\\n)*?\\*\\/&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">),</span>
		<span class="s2">&quot;&quot;</span> <span class="c1">// strip out C-style comments (/*  */)</span>
	<span class="p">)</span>
<span class="p">);</span>                             
<span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;CONFIG:&quot;</span><span class="p">);</span>   
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">prop</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">[</span><span class="nx">prop</span><span class="p">]);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>logger.debug(sys.inspect(config, true, null));  </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>initialize serial port connection to kegerator     </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">keg</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">device</span><span class="p">,</span>  
		 <span class="nx">config</span><span class="p">.</span><span class="nx">db_name</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">twitter_enabled</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">twitter_consumer_key</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">twitter_consumer_secret</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">twitter_access_token_key</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">twitter_access_token_secret</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">admin_ui_password</span><span class="p">,</span>
		 <span class="nx">config</span><span class="p">.</span><span class="nx">high_temp_threshold</span><span class="p">);</span>    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Create several node-static server instances to serve the './public' folder</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">css</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static/css&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">css2</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static/css/ui-lightness&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">css3</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static/css/ui-lightness/images&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">images</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static/images&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">js</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static/js&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">js2</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">Server</span><span class="p">)(</span><span class="s1">&#39;./static/js/profiling&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Routes</h2>

<p>We're using <a href="https://github.com/laughinghan/choreographer"><strong>choreographer</strong></a> for our request routing</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">ignoreCase</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>	   </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>///// ADD ALL YOUR ROUTES HERE  /////////</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">base</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="s1">&#39;/index.html&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>     
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/socketPort.json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
 	 <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
	 <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">socket_client_connect_port</span><span class="p">);</span>
<span class="p">})</span>    
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/temperatureHistory.json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">keg</span><span class="p">.</span><span class="nx">getTemperatureTrend</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>For some reason, the following line doesn't work with the highcharts.
res.send(result, {'Content-Type': 'text/json'}, 200);
console.log(result);</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">})</span>          
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/pourHistory.json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">keg</span><span class="p">.</span><span class="nx">getPourTrend</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">})</span>       
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/kegInfo.json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">keg</span><span class="p">.</span><span class="nx">getKegInfo</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>   
	   <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
	   <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>                 
	<span class="p">});</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/addUser.json&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">){</span>
	<span class="nx">keg</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span>
		<span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
		<span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
		<span class="p">});</span>	
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/css/ui-lightness/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">css2</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/css/ui-lightness/images/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">css3</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/css/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">css</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/images/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">images</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/js/profiling/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">js2</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/js/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">js</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Create an HTTP server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">router</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">http_port</span><span class="p">);</span>
                                  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create a server for the web socket
Depending on the port assignments, this 
could be the same server that we use for HTTP</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">socketServer</span> <span class="o">=</span> <span class="nx">server</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">http_port</span> <span class="o">!=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">socket_listen_port</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="nx">socketServer</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">();</span>
	<span class="nx">socketServer</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">socket_listen_port</span><span class="p">);</span>
<span class="p">}</span>                          </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Setup Socket.IO</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">socketServer</span><span class="p">);</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">){</span>
	<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Client Connected&#39;</span><span class="p">);</span>
	
	<span class="nx">keg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
           	<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">data</span> <span class="p">}));</span>
		<span class="p">}</span>
	<span class="p">});</span>
	
	<span class="nx">keg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">data</span> <span class="p">}));</span>
		<span class="p">}</span>
	<span class="p">});</span>
	
	<span class="nx">keg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;flow&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;flow&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">data</span> <span class="p">}));</span>
		<span class="p">}</span>
	<span class="p">});</span>
	
	<span class="nx">keg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pour&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;pour&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">data</span> <span class="p">}));</span>
		<span class="p">}</span>
	<span class="p">});</span>
	<span class="nx">keg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;deny&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;deny&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">data</span> <span class="p">}));</span>
		<span class="p">}</span>
	<span class="p">});</span>
	<span class="nx">keg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;remaining&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;remaining&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">data</span> <span class="p">}));</span>
		<span class="p">}</span>
	<span class="p">});</span>
	<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Client Disconnected.&#39;</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">});</span>

<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Listening for HTTP requests on http://0.0.0.0:&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">http_port</span> <span class="p">);</span>  
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Listening for web socket requests on http://0.0.0.0:&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">socket_listen_port</span> <span class="p">);</span>   
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Telling clients to connect web socket on port: &#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">socket_client_connect_port</span> <span class="p">);</span>   

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 